<!DOCTYPE html>
<html lang="es" id="htmlLang">
<head>
  <meta charset="UTF-8" />
  <title id="pageTitle">Calculadora de Evolución Digimon</title>

  <!-- ✅ Estilo de simple.css -->
  <link rel="stylesheet" href="https://cdn.simplecss.org/simple.css">
<style>
	#languageSelector {
	  float: none;              /* quitar float */
	  display: inline-flex;     /* inline-flex para que no ocupe todo el ancho */
	  justify-content: center;  /* centrar contenido interno */
	  align-items: center;      /* centrar vertical */
	  margin: 0 auto;           /* centrar el bloque */
	  width: auto;              /* ancho automático, no 100% */
	}
    
    nav a {
      margin-right: 10px;
    }
    
/* Ajustar el ancho de las columnas de la tabla editable */
	#editableFieldsTable {
	  table-layout: auto;  /* Cambiar de 'fixed' a 'auto' */
	  width: 100%;
	}
    /* Ajustar anchos específicos para cada columna */
    #editableFieldsTable th,
    #editableFieldsTable td {
      padding: 8px 6px;
      text-align: center;
      font-size: 16px; /* Aumentado de 13px a 16px */
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    /* Permitir que los headers se ajusten en múltiples líneas */
    #editableFieldsTable th {
      line-height: 1.3;
      vertical-align: middle;
      font-weight: bold;
    }
    /* Los anchos específicos se manejan dinámicamente con JavaScript */
    
    /* Anchos específicos para campos estáticos */
    #editableFieldsTable th:nth-child(1), /* HP Base */
    #editableFieldsTable td:nth-child(1) {
      min-width: 90px;
      width: 90px;
    }

    #editableFieldsTable th:nth-child(2), /* HP Entrenado */
    #editableFieldsTable th:nth-child(3), /* ATK Entrenado */
    #editableFieldsTable th:nth-child(4), /* SPD Entrenado */
    #editableFieldsTable td:nth-child(2),
    #editableFieldsTable td:nth-child(3),
    #editableFieldsTable td:nth-child(4) {
      min-width: 110px;
      width: 110px;
    }

    #editableFieldsTable th:nth-child(5), /* Stat Superior */
    #editableFieldsTable td:nth-child(5) {
      min-width: 140px;
      width: 140px;
    }
	#editableFieldsTable th:nth-child(6), /* Peso */
	#editableFieldsTable td:nth-child(6) {
	  min-width: 80px;
	  width: 80px;
	}    
    /* Estilos base para campos numéricos y dropdowns */
    #editableFieldsTable input[type="number"] {
      text-align: center;
    }
    
    #editableFieldsTable select {
      text-align: left;
    }
    /* Ajustar inputs y selects para que se adapten al ancho de la celda */
    #editableFieldsTable input,
    #editableFieldsTable select {
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
      font-size: 15px; /* Aumentado de 14px a 15px */
      padding: 4px 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    /* Campos específicos más pequeños */
    #editableFieldsTable input[id*="Peso"],
    #editableFieldsTable input[id*="Weight"],
    #editableFieldsTable input[id*="Errores"],
    #editableFieldsTable input[id*="Errors"],
    #editableFieldsTable input[id*="WinRate"]
	{
      text-align: center;
    }
    
    /* Separador visual entre campos numéricos y dropdowns */
    #editableFieldsTable .dropdown-separator {
      border-left: 2px solid #ddd;
    }
    /* Tabla de datos del digimon también más compacta */
    #autoFieldsTable {
      width: 100%;
      margin-bottom: 20px;
    }
    #autoFieldsTable th,
    #autoFieldsTable td {
      padding: 10px 8px;
      text-align: center;
      font-size: 16px; /* Mantener consistencia */
    }
    #autoFieldsTable th {
      font-weight: bold;
    }

    /* ====================== ESTILOS PARA HELP POPUP ====================== */
    /* Estilos para el icono de ayuda */
    .help-icon {
      display: inline-block;
      width: 16px;
      height: 16px;
      background-color: #007bff;
      color: white;
      border-radius: 50%;
      text-align: center;
      font-size: 12px;
      line-height: 16px;
      cursor: pointer;
      margin-left: 5px;
      user-select: none;
      vertical-align: middle;
    }

    .help-icon:hover {
      background-color: #0056b3;
    }

    /* Overlay del popup */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 20px;
      box-sizing: border-box;
    }

    .popup-overlay.show {
      display: flex;
    }

    /* Contenedor del popup */
    .popup-container {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      animation: popupIn 0.3s ease-out;
    }

    /* Animación de entrada */
    @keyframes popupIn {
      from {
        opacity: 0;
        transform: scale(0.8);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Botón de cerrar */
    .popup-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: rgba(0, 0, 0, 0.6);
      color: white;
      border: none;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .popup-close:hover {
      background: rgba(0, 0, 0, 0.8);
    }

    /* Imagen del popup */
    .popup-image {
      width: 100%;
      height: auto;
      display: block;
      max-height: 80vh;
      object-fit: contain;
    }
    /* ====================== FIN ESTILOS HELP POPUP ====================== */

    /* Responsive: en pantallas pequeñas permitir scroll horizontal */
    @media (max-width: 768px) {
      #editableFieldsTable th,
      #editableFieldsTable td {
        font-size: 14px; /* Reducir solo en móvil */
        padding: 6px 4px;
      }
      
      #editableFieldsTable input,
      #editableFieldsTable select {
        font-size: 13px;
      }
      
      /* Reducir anchos en móvil */
      #editableFieldsTable th:nth-child(1),
      #editableFieldsTable td:nth-child(1) {
        min-width: 70px;
        width: 70px;
      }
      
      #editableFieldsTable th:nth-child(2),
      #editableFieldsTable th:nth-child(3),
      #editableFieldsTable th:nth-child(4),
      #editableFieldsTable td:nth-child(2),
      #editableFieldsTable td:nth-child(3),
      #editableFieldsTable td:nth-child(4) {
        min-width: 85px;
        width: 85px;
      }
      
      #editableFieldsTable th:nth-child(5),
      #editableFieldsTable td:nth-child(5) {
        min-width: 110px;
        width: 110px;
      }
	 #editableFieldsTable th:nth-child(6), /* Peso móvil */
	#editableFieldsTable td:nth-child(6) {
	  min-width: 65px;
	  width: 65px;
	}     
      .table-container {
        overflow-x: auto;
      }
      
      #languageSelector {
        float: none;
        display: block;
        margin: 10px auto;
      }

      /* Help popup responsive */
      .popup-container {
        max-width: 95vw;
        max-height: 85vh;
      }
      
      .popup-close {
        width: 35px;
        height: 35px;
        font-size: 20px;
        top: 5px;
        right: 10px;
      }

      .help-icon {
        width: 18px;
        height: 18px;
        line-height: 18px;
        font-size: 13px;
      }
    }
    
    @media (max-width: 480px) {
      #editableFieldsTable th,
      #editableFieldsTable td {
        font-size: 12px;
        padding: 4px 2px;
      }
      
      #editableFieldsTable input,
      #editableFieldsTable select {
        font-size: 11px;
      }

      /* Help popup móvil pequeño */
      .popup-overlay {
        padding: 10px;
      }
      
      .popup-container {
        max-width: 98vw;
        max-height: 90vh;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1 id="mainTitle" data-translate="title">Calculadora de Evolución Digimon</h1>
	<p id="mainSubtitle" data-translate="subtitle">Creado por Rodrigoalag</p>
    <nav>
      <a href="./index.html">Main Hub</a>
      <a href="./calculadora.html">Digimon Evo Calc</a>
      <a href="./digimonreqs.html">Digimon Reqs</a>
      <a href="./StatRanking.html">Digimon Stat Ranking</a>
	  <a href="./arbolevolutivo.html">Digimon Evolutive Tree</a>
      <a target="_blank" href="https://ndcalcs.github.io/">Carrow Website - General Info</a>
      <a target="_blank" href="https://whiterickle.neocities.org/Road%20To%20Perfect">WhiteRickle Website - Road To Perfect - Guides and Calculator</a>
	  <a target="_blank" href="https://docs.google.com/spreadsheets/d/1WzSCjaje4apqByKV9HyXsLXEao92MoT07VQsNRqeAvI/edit?gid=1769528122#gid=1769528122">Driver Installation Guide</a>
    </nav>
	  <select id="languageSelector">
      <option value="es">Español</option>
      <option value="en">English</option>
    </select>
  </header>
<section>
	<p id="disclaimer">
	  DISCLAIMER: Condiciones recopiladas basados en la experiencia del discord y screenshots. PUEDEN haber errores, en caso de encontrar alguno, contactarme en el discord de Net Driver haciendo ping a @rodrigoalag para revisar el caso.
	</p>
</section>

  <label for="digimonSelect" data-translate="selectDigimon">Selecciona las opciones:</label>
  <select id="digimonSelect"></select>
  
  <h3 id="digimonDataTitle" data-translate="digimonData">Datos del Digimon</h3>
  <table id="autoFieldsTable">
    <thead>
      <tr>
        <th data-translate="id">ID</th>
        <th data-translate="tama">Tama</th>
        <th data-translate="level">Nivel</th>
        <th data-translate="stage">Etapa</th>
        <th data-translate="attribute">Atributo</th>
        <th data-translate="type">Tipo</th>
      </tr>
    </thead>
    <tbody id="autoFields"></tbody>
  </table>
  
  <h3 id="fieldsToCompleteTitle" data-translate="fieldsToComplete">Campos a completar</h3>
  <div class="table-container">
    <table id="editableFieldsTable">
      <thead>
        <tr id="editableFieldsHeaders"></tr>
      </thead>
      <tbody>
        <tr id="editableFields"></tr>
      </tbody>
    </table>
  </div>
  
  <button id="calcularBtn" data-translate="calculate">Calcular evolución</button>
  <div id="resultados"></div>
  <p id="evolucionTexto" style="margin-top:15px; font-weight:bold;"></p>

  <!-- Popup de ayuda para HP Base -->
  <div id="helpPopupOverlay" class="popup-overlay" onclick="closeHelpPopup(event)">
    <div class="popup-container">
      <button class="popup-close" onclick="closeHelpPopup()" aria-label="Cerrar">×</button>
      <img id="helpPopupImage" class="popup-image" src="" alt="Imagen de ayuda">
    </div>
  </div>

  <script>
  // ============================================
// FUNCIONES DEL POPUP DE AYUDA - SOLO AÑADIDAS, SIN MODIFICAR CÓDIGO EXISTENTE
// ============================================

// Configuración de imagen de ayuda para HP Base
const helpImages = {
  hpbase: 'img/explicacionentrenamientobaseen.png' // ← Ruta de la imagen actualizada
};

// Función para mostrar el popup
function showHelpPopup(helpKey) {
  const overlay = document.getElementById('helpPopupOverlay');
  const image = document.getElementById('helpPopupImage');
  
  // Configurar la imagen
  if (helpImages[helpKey]) {
    image.src = helpImages[helpKey];
    image.alt = `Ayuda para ${helpKey}`;
    
    // Mostrar el popup
    overlay.classList.add('show');
    
    // Prevenir scroll del body
    document.body.style.overflow = 'hidden';
    
    // Focus en el popup para accesibilidad
    overlay.focus();
  }
}

// Función para cerrar el popup
function closeHelpPopup(event) {
  const overlay = document.getElementById('helpPopupOverlay');
  
  // Solo cerrar si se hace click en el overlay o en el botón de cerrar
  if (!event || event.target === overlay || event.target.classList.contains('popup-close')) {
    overlay.classList.remove('show');
    document.body.style.overflow = '';
    
    // Limpiar la imagen
    document.getElementById('helpPopupImage').src = '';
  }
}

// Cerrar popup con tecla Escape
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    closeHelpPopup();
  }
});

// Prevenir cierre accidental al hacer click en la imagen
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.popup-container');
  if (container) {
    container.addEventListener('click', function(event) {
      event.stopPropagation();
    });
  }

  // Manejar carga de imagen con error
  const helpImage = document.getElementById('helpPopupImage');
  if (helpImage) {
    helpImage.addEventListener('error', function() {
      this.alt = 'Error al cargar la imagen de ayuda';
      this.style.minHeight = '200px';
      this.style.display = 'flex';
      this.style.alignItems = 'center';
      this.style.justifyContent = 'center';
      this.style.backgroundColor = '#f0f0f0';
    });
  }

  // Touch events para mejor experiencia móvil
  let touchStartY = 0;
  const overlay = document.getElementById('helpPopupOverlay');
  if (overlay) {
    overlay.addEventListener('touchstart', function(e) {
      touchStartY = e.touches[0].clientY;
    });

    overlay.addEventListener('touchend', function(e) {
      const touchEndY = e.changedTouches[0].clientY;
      const deltaY = touchEndY - touchStartY;
      
      // Si desliza hacia abajo más de 50px, cerrar popup
      if (deltaY > 50) {
        closeHelpPopup();
      }
    });
  }
});

// ✅ FUNCIÓN PARA AGREGAR EL HELP ICON AL HP BASE CUANDO SE CREE LA TABLA
function addHelpIconToHPBase() {
  // Esperar un poco y buscar el header de HP Base
  setTimeout(() => {
    const headersRow = document.getElementById('editableFieldsHeaders');
    if (!headersRow) return;

    Array.from(headersRow.children).forEach(header => {
      const headerText = header.textContent.trim();
      
      // Buscar HP Base en cualquier idioma y agregar help icon si no lo tiene
      if ((headerText === 'HP Base' || headerText.includes('HP Base')) && !header.querySelector('.help-icon')) {
        const helpIcon = document.createElement('span');
        helpIcon.className = 'help-icon';
        helpIcon.onclick = () => showHelpPopup('hpbase');
        helpIcon.title = 'Ver ayuda / Show help';
        helpIcon.textContent = '?';
        helpIcon.setAttribute('aria-label', 'Ver ayuda');
        
        // Agregar el icono al header
        header.appendChild(document.createTextNode(' '));
        header.appendChild(helpIcon);
      }
    });
  }, 500); // Dar tiempo suficiente para que se cree la tabla
}

// Observador para detectar cuando se crea/modifica la tabla
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
      // Verificar si se agregaron headers a la tabla
      const headersRow = document.getElementById('editableFieldsHeaders');
      if (headersRow && headersRow.children.length > 0) {
        addHelpIconToHPBase();
      }
    }
  });
});

// Observar cambios en la tabla
document.addEventListener('DOMContentLoaded', () => {
  const tableContainer = document.querySelector('.table-container');
  if (tableContainer) {
    observer.observe(tableContainer, {
      childList: true,
      subtree: true
    });
  }
  
  // También intentar agregar el icono inmediatamente por si la tabla ya existe
  addHelpIconToHPBase();
});

// ============================================
// SISTEMA DE TRADUCCIONES ORIGINAL - SIN MODIFICACIONES
// ============================================

// Diccionario de traducciones
const translations = {
  es: {
    // Textos de interfaz
    title: "Calculadora de Evolución Digimon",
    subtitle: "Creado por Rodrigoalag",
    selectDigimon: "Selecciona las opciones:",
    digimonData: "Datos del Digimon",
    fieldsToComplete: "Campos a completar",
    calculate: "Calcular evolución",
    disclaimer: "DISCLAIMER: Condiciones recopiladas basados en la experiencia del discord y screenshots. PUEDEN haber errores, en caso de encontrar alguno, contactarme en el discord de Net Driver haciendo ping a @rodrigoalag para revisar el caso.",
    // Headers de tabla
    id: "ID",
    tama: "Tama",
    level: "Nivel",
    stage: "Etapa",
    attribute: "Atributo",
    type: "Tipo",
    // Campos editables comunes
    peso: "Peso",
    errores: "Errores de Crianza",
	induceddeath: "Muerte inducida sin Carne X o Program",
    entrenamiento: "% Entrenamiento",
    vinculo: "Vínculo máximo alcanzado",
	vinculo2: "Vinculo al momento de evolucionar",
	entrenos25: "Menos de 15 entrenamientos?",
    batallas: "Batallas",
    winRate: "WinRate",
    entrenamientopregunta: '¿Realizó Entrenamiento?',
    statsuperior: 'Stat Superior',
    agumon06: '¿Obtuviste dos perfect en las ultimas dos generaciones/Obtuviste antes a Agumon 06?',
    driverequip: 'Driver Equipado',
    victorias: 'Victorias',
    bonus: 'Bonus',
    // Opciones de selects
    si: "Sí",
    no: "No",
    Balanceado: "Balanceado",
    Ninguno: "Ninguno",
    Compuesto: "Compuesto", 
    Dinosaurio: "Dinosaurio",
    Vacuna: "Vacuna",
    Maquina: "Maquina",
    Tierra: "Tierra",
    Hielo: "Hielo",
    Mutante: "Mutante",
    caca: "5 Caca",
    sardina: "5 Sardinas",
    bellotad: "Bellota Dorada",
    verduracongelada: "Verdura Congelada como ultima comida antes de la evolucion",
    hongocongelado: "Hongo Congelado como ultima comida antes de la evolucion",
    Chatarra: "Chatarra",
    insekilow: "Starmon o ShootingStarmon Driver",
    insekimid: "SuperStarmon o DarkSuperStarmon Driver",
    insekihigh: "SuperStarmon y DarkSuperStarmon Driver",
    selecciona: "--Selecciona--",
    puntaje: "Puntaje Total",
    program: "Program",
    xross: "Xross o Install",
    etapa: "Etapa",
    digimon: "Digimon",
    gigawaruxross: "3 Monzaemon Driver en WaruMonzaemon o 3 WaruMonzaemon Driver en Monzaemon",
    comida: "Comida",
    vnegativo: "Alcanzo vinculo negativo?",
	trainedhp: "HP Entrenado",
	trainedatk: "ATK Entrenado",
	trainedspd: "SPD Entrenado"
  },
  en: {
    // Interface texts
    title: "Digimon Evolution Calculator",
    subtitle: "Created by Rodrigoalag",
    selectDigimon: "Select your options:",
    digimonData: "Digimon Data",
    fieldsToComplete: "Fields to Complete",
    calculate: "Calculate evolution",
    disclaimer:"DISCLAIMER: Conditions based on the user experience of the discord and screenshots. There can be errors or mistakes, in case of finding one, please contact me at Net Driver discord by pinging @rodrigoalag to check the case.",
    // Table headers
    id: "ID",
    tama: "Tama",
    level: "Level",
    stage: "Stage",
    attribute: "Attribute",
    type: "Type",
    // Common editable fields
    peso: "Weight",
    errores: "Care Mistakes",
    entrenamiento: "% Training",
    vinculo: "Max Bond Achieved",
	induceddeath: "Induced death without Meat X or Death Program",
	vinculo2: "Bond at evolution",
	entrenos25: "Less than 15 trainings?",
    batallas: "Battles",
    winRate: "WinRate",
    entrenamientopregunta: 'Did you make a training?',
    statsuperior: 'Superior Stat',
    agumon06: 'Did you have 2 perfects on last two generations/Did you obtain Agumon 06?',
    driverequip: 'Driver equipped',
    victorias: 'Victories',
    bonus: 'Bonus',
    // Select options
    si: "Yes",
    no: "No",
    Balanceado: "Balanced",
    Ninguno: "None",
    Compuesto: "Composite", 
    Dinosaurio: "Dinosaur",
    Vacuna: "Vaccine",
    Maquina: "Machine",
    Hielo: "Ice",
    Mutante: "Mutant",
    Tierra: "Earth",
    caca: "5 Poop",
    sardina: "5 DigiSardine",
    bellotad: "Golden Acorn",
    verduracongelada: "Frozen Vegetable as last food eaten before evolving.",
    hongocongelado: "Frozen Mushroom as last food eaten before evolving.",
    Chatarra: "Metal Scrap",
    insekilow: "Starmon or ShootingStarmon Driver",
    insekimid: "SuperStarmon or DarkSuperStarmon Driver",
    insekihigh: "SuperStarmon and DarkSuperStarmon Driver",
    selecciona: "--Select--",
    puntaje: "Total Points",
    program: "Program",
    xross: "Xross or Install",
    etapa: "Stage",
    digimon: "Digimon",
    gigawaruxross: "3 Monzaemon Driver in WaruMonzaemon or 3 WaruMonzaemon Driver in Monzaemon",
    comida:"Food",
    vnegativo: "Reached negative bond?",
	trainedhp: "Trained HP",
	trainedatk: "Trained ATK",
	trainedspd: "Trained SPD"
  }
};

// Variable para idioma actual
let currentLanguage = 'es';

// ✅ NUEVA FUNCIÓN: Detectar idioma automáticamente
function detectLanguage() {
  // Logger 1: Ver el valor del atributo lang del HTML
  const htmlLangElement = document.getElementById('htmlLang');
  const htmlLangValue = document.documentElement.getAttribute('lang') || htmlLangElement?.getAttribute('lang');
  console.log('🔍 HTML Lang detectado:', htmlLangValue);
  
  // 1. Verificar si hay un idioma guardado (ahora desde HTML)
  const savedLanguage = document.documentElement.getAttribute('lang') || document.getElementById('htmlLang')?.getAttribute('lang');
  
  // Logger 2: Ver el savedLanguage que se está usando
  console.log('💾 Saved Language obtenido:', savedLanguage);
  
  if (savedLanguage && translations[savedLanguage]) {
    console.log('✅ Usando idioma guardado:', savedLanguage);
    return savedLanguage;
  }
  
  // 2. Detectar idioma del navegador
  const browserLanguage = navigator.language || navigator.userLanguage;
  const languageCode = browserLanguage.split('-')[0].toLowerCase();
  console.log('🌐 Idioma del navegador:', languageCode);
  
  // 3. Verificar si el idioma del navegador está soportado
  if (translations[languageCode]) {
    console.log('✅ Usando idioma del navegador:', languageCode);
    return languageCode;
  }
  
  // 4. Fallback a español por defecto
  console.log('⚠️ Usando fallback a español');
  return 'es';
}

// Función para traducir texto
function translate(key, lang = currentLanguage) {
  return translations[lang] && translations[lang][key] ? translations[lang][key] : key;
}

// Función para actualizar interfaz cuando cambie idioma
function updateInterfaceLanguage() {
  // Actualizar título de página
  document.title = translate('title');
  const pageTitle = document.getElementById('pageTitle');
  if (pageTitle) {
    pageTitle.textContent = translate('title');
  }
  
  // Actualizar párrafo de disclaimer
  const disclaimer = document.getElementById('disclaimer');
  if (disclaimer) {
    disclaimer.textContent = translate('disclaimer');
  }
  
  // Actualizar elementos con data-translate
  document.querySelectorAll('[data-translate]').forEach(element => {
    const key = element.getAttribute('data-translate');
    element.textContent = translate(key);
  });
  
  // Actualizar headers de tablas
  updateTableHeaders();
  
  // Actualizar campos dinámicos si existen
  updateEditableFieldsHeaders();
  
  // Traducir opciones de todos los selects
  const selects = document.querySelectorAll('#editableFields select');
  selects.forEach(select => translateSelectOptions(select));
  
  // Traducir contenido de tabla de datos del Digimon
  translateAutoFieldsContent();
  
  // Actualizar atributo lang del HTML
  const htmlLang = document.getElementById('htmlLang');
  if (htmlLang) {
    htmlLang.setAttribute('lang', currentLanguage);
  }
  
  // ✅ NUEVO: Actualizar el selector de idioma sin disparar el evento
  const languageSelector = document.getElementById('languageSelector');
  if (languageSelector && languageSelector.value !== currentLanguage) {
    languageSelector.value = currentLanguage;
  }
}

function updateTableHeaders() {
  // Headers de la tabla de autoFields
  const autoHeaders = document.querySelectorAll('#autoFieldsTable th[data-translate]');
  autoHeaders.forEach(header => {
    const key = header.getAttribute('data-translate');
    header.textContent = translate(key);
  });

  // Headers de la tabla de resultados
  const resultadosHeaders = document.querySelectorAll('#resultados th[data-translate]');
  resultadosHeaders.forEach(header => {
    const key = header.getAttribute('data-translate');
    header.textContent = translate(key);
  });
}

function updateEditableFieldsHeaders() {
  const headersRow = document.getElementById('editableFieldsHeaders');
  const resultados = document.getElementById('resultados');

  // Mapeo de textos en español a claves de traducción
  const headerMapping = {
    'Peso': 'peso',
    'Weight': 'peso',
    'Errores': 'errores',
    'Errors': 'errores',
	'Muerte inducida sin Carne X o Program (30% de salir)': 'induceddeath',
    'Induced death without Meat X or Death Program (30% Chance)': 'induceddeath',
    'Muerte inducida sin Carne X o Program': 'induceddeath',
    'Induced death without Meat X or Death Program': 'induceddeath',
    '% Entrenamiento': 'entrenamiento',
    '% Training': 'entrenamiento',
    'Vínculo máximo alcanzado': 'vinculo',
	'Vinculo Maximo Alcanzado': 'vinculo',
	'Alcanzo vinculo negativo?':'vnegativo',
    'Vinculo': 'vinculo',
	'Vinculo al momento de evolucionar':'vinculo2',
	'Bond at evolution':'vinculo2',
	'Bonus Vinculo al momento de evolucionar':'vinculo2',
	"Menos de 15 entrenamientos?": "entrenos25",
	"Less than 15 trainings?": "entrenos25",
    'Max Bond Achieved': 'vinculo',
    'Batallas': 'batallas',
    'Battles': 'batallas',
    'WinRate': 'winRate',
    '¿Realizó Entrenamiento?': 'entrenamientopregunta',
    'Did you make a training?': 'entrenamientopregunta',
    'Stat Superior': 'statsuperior',
    'Superior Stat': 'statsuperior',
    '¿Obtuviste dos perfect en las ultimas dos generaciones/Obtuviste antes a Agumon 06?': 'agumon06',
    'Did you have 2 perfects on last two generations/Did you obtain Agumon 06?': 'agumon06',
    'Driver Equipado': 'driverequip',
    'Driver equipped': 'driverequip',
    'Victorias': 'victorias',
    'Victories': 'victorias',
    'Puntaje Total': 'puntaje',
    'Total Points': 'puntaje',
    'Etapa': 'etapa',
    'Stage': 'etapa',
    'Digimon': 'digimon',
    'Program': 'program',
    'Bonus': 'bonus',
    'Xross': 'xross',
    'Comida':'comida',
    'Food': 'comida',
	"HP Entrenado":'trainedhp',
	"Trained HP":'trainedhp',
    "ATK Entrenado":'trainedatk',
    "Trained ATK":'trainedatk',
    "SPD Entrenado":'trainedspd',
    "Trained SPD":'trainedspd'
  };

  // Traducir encabezados
  if (headersRow) {
    Array.from(headersRow.children).forEach(header => {
      const currentText = header.textContent.trim();
      const translationKey = headerMapping[currentText];
      if (translationKey) {
        header.textContent = translate(translationKey);
      }
    });
  }

  // Traducir texto del elemento 'resultados' si es texto simple
  if (resultados) {
    const text = resultados.textContent.trim();
    const translationKey = headerMapping[text];
    if (translationKey) {
      resultados.textContent = translate(translationKey);
    }
  }
}

function translateSelectOptions(select) {
  if (!select) return;

  Array.from(select.options).forEach(option => {
    const text = option.textContent.trim().toLowerCase();

    // Mapear posibles textos (español e inglés) a claves del diccionario
    const matchTable = {
      'sí': 'si',
      'si': 'si',
      'yes': 'si',
      'no': 'no',
      'balanceado': 'Balanceado',
      'balanced': 'Balanceado',
      'ninguno': 'Ninguno',
      'none': 'Ninguno',
      'compuesto': 'Compuesto',
      'composite': 'Compuesto',
      'dinosaurio': 'Dinosaurio',
      'dinosaur': 'Dinosaurio',
      'vacuna': 'Vacuna',
      'vaccine': 'Vacuna',
      'maquina': 'Maquina',
      'machine': 'Maquina',
      'hielo': 'Hielo',
      'ice': 'Hielo',
      'mutante': 'Mutante',
      'mutant': 'Mutante',
      'tierra': 'Tierra',
      'earth': 'Tierra',
      '5 Caca': 'caca',
      '5 poop': 'caca',
      '5 sardinas': 'sardina',
      '5 digisardine': 'sardina',
      'bellota dorada': 'bellotad',
      'golden acorn': 'bellotad',
	 'verdura congelada': 'verduracongelada',
	  'verdura congelada como ultima comida antes de la evolucion': 'verduracongelada',
	  'frozen vegetable as last food eaten before evolving.': 'verduracongelada',
	  'hongo congelado': 'hongocongelado',
	  'hongo congelado como ultima comida antes de la evolucion': 'hongocongelado',
	  'frozen mushroom as last food eaten before evolving.': 'hongocongelado',
      'chatarra': 'Chatarra',
      'metal scrap': 'Chatarra',
      'starmon o shootingstarmon driver': 'insekilow',
      'starmon or shootingstarmon driver': 'insekilow',
      'superstarmon o darksuperstarmon driver': 'insekimid',
      'superstarmon or darksuperstarmon driver': 'insekimid',
      'superstarmon y darksuperstarmon driver': 'insekihigh',
      'superstarmon and darksuperstarmon driver': 'insekihigh',
      '--selecciona--': 'selecciona',
      '--select--': 'selecciona',
      '3 monzaemon driver en warumonzaemon o 3 warumonzaemon driver en monzaemon': 'gigawaruxross',
      '3 monzaemon driver in warumonzaemon or 3 warumonzaemon driver in monzaemon': 'gigawaruxross'
    };

    const key = matchTable[text];
    if (key) {
      option.textContent = translate(key);
    }
  });
}


function translateAutoFieldsContent() {
  const autoFields = document.getElementById('autoFields');
  if (!autoFields) return;

  const cells = autoFields.querySelectorAll('td');
  cells.forEach(cell => {
    const rawText = cell.textContent.trim();
    const key = Object.keys(translations[currentLanguage]).find(k => k.toLowerCase() === rawText.toLowerCase());

    if (key) {
      cell.textContent = translate(key);
    }
  });
}

function translateresultadosContent() {
  const resultados = document.getElementById('resultados');
  if (!resultados) return;

  const cells = resultados.querySelectorAll('th');
  cells.forEach(cell => {
    const rawText = cell.textContent.trim();
    const key = Object.keys(translations[currentLanguage]).find(k => k.toLowerCase() === rawText.toLowerCase());

    if (key) {
      cell.textContent = translate(key);
    }
  });
}

// Función para reorganizar campos con dropdowns a la derecha
function reorganizeFields() {
  const originalScript = document.createElement('script');
  originalScript.src = 'script.js';

  originalScript.onload = function() {
    const retryInterval = setInterval(() => {
      if (typeof window.populateEditableFields === 'function') {
        const originalPopulateEditableFields = window.populateEditableFields;

        window.populateEditableFields = function(digimon) {
          originalPopulateEditableFields(digimon);

          setTimeout(() => {
            reorganizeTableColumns();
            updateEditableFieldsHeaders();

            const selects = document.querySelectorAll('#editableFields select');
            selects.forEach(select => translateSelectOptions(select));

            updateInterfaceLanguage();
            
            // ✅ Agregar help icon después de reorganizar y actualizar estilos
            setTimeout(() => {
              addHelpIconToHPBase();
            }, 200);
          }, 150);
        };

        clearInterval(retryInterval);
      }
    }, 50);
  };

  document.head.appendChild(originalScript);
}

function reorganizeTableColumns() {
  const headersRow = document.getElementById('editableFieldsHeaders');
  const fieldsRow = document.getElementById('editableFields');
  
  if (!headersRow || !fieldsRow) return;
  
  const headers = Array.from(headersRow.children);
  const fields = Array.from(fieldsRow.children);
  
  // Crear mapa de campos por nombre del header
  const fieldMap = {};
  
  for (let i = 0; i < headers.length; i++) {
    const fieldCell = fields[i];
    const headerCell = headers[i];
    
    if (fieldCell && headerCell) {
      const headerText = headerCell.textContent.trim();
      fieldMap[headerText] = { header: headerCell, field: fieldCell };
    }
  }
  
  // Orden específico requerido (en español, se traducirán después)
  const specificOrder = [
    'Peso', 
    'Errores', 
    '% Entrenamiento', 
    'Vinculo',
    'Vínculo máximo alcanzado', 
	'Vinculo maximo alcanzado',
	'Bonus Vinculo al momento de evolucionar',
	'vinculo2',
    'Batallas', 
    'WinRate'
  ];
  
  // Separar campos ordenados y dropdowns restantes
  const orderedFields = [];
  const remainingDropdowns = [];
  
  // Primero, agregar campos en el orden específico
  specificOrder.forEach(fieldName => {
    if (fieldMap[fieldName]) {
      orderedFields.push(fieldMap[fieldName]);
      delete fieldMap[fieldName];
    }
  });
  
  // Agregar dropdowns restantes
  Object.values(fieldMap).forEach(item => {
    const hasSelect = item.field.querySelector('select');
    if (hasSelect) {
      remainingDropdowns.push(item);
    }
  });
  
  // Limpiar las filas
  headersRow.innerHTML = '';
  fieldsRow.innerHTML = '';
  
  // Agregar campos en orden específico
  orderedFields.forEach(item => {
    headersRow.appendChild(item.header);
    fieldsRow.appendChild(item.field);
  });
  
  // Agregar dropdowns restantes
  remainingDropdowns.forEach((item, index) => {
    if (index === 0 && orderedFields.length > 0) {
      item.header.classList.add('dropdown-separator');
      item.field.classList.add('dropdown-separator');
    }
    headersRow.appendChild(item.header);
    fieldsRow.appendChild(item.field);
  });
  
  // Actualizar estilos CSS para la nueva organización
  updateColumnStyles();
}

function updateColumnStyles() {
  const fieldsRow = document.getElementById('editableFields');
  const headersRow = document.getElementById('editableFieldsHeaders');
  if (!fieldsRow || !headersRow) return;
  
  const totalCols = fieldsRow.children.length;
  
  const style = document.createElement('style');
  style.id = 'dynamic-column-styles';
  
  let css = '';
  
  // Iterar por cada columna
  for (let i = 1; i <= totalCols; i++) {
    const field = fieldsRow.children[i-1];
    
    if (field) {
      const hasSelect = field.querySelector('select');
      
      if (hasSelect) {
        // TODOS los dropdowns del mismo tamaño que HP Entrenado, ATK Entrenado, SPD Entrenado
        css += `
          #editableFieldsTable th:nth-child(${i}),
          #editableFieldsTable td:nth-child(${i}) {
            min-width: 110px !important;
            width: 110px !important;
          }
        `;
        
        // Responsive móvil - mismo tamaño que HP/ATK/SPD Entrenado en móvil
        css += `
          @media (max-width: 768px) {
            #editableFieldsTable th:nth-child(${i}),
            #editableFieldsTable td:nth-child(${i}) {
              min-width: 85px !important;
              width: 85px !important;
            }
          }
        `;
      } else {
        // Campos numéricos - mantener tamaños originales según el CSS base
        const header = headersRow.children[i-1];
        if (header) {
          const headerText = header.textContent.trim().toLowerCase();
          
          if (headerText.includes('hp') && headerText.includes('base')) {
            // HP Base - tamaño original del CSS
            css += `
              #editableFieldsTable th:nth-child(${i}),
              #editableFieldsTable td:nth-child(${i}) {
                min-width: 90px !important;
                width: 90px !important;
              }
              @media (max-width: 768px) {
                #editableFieldsTable th:nth-child(${i}),
                #editableFieldsTable td:nth-child(${i}) {
                  min-width: 70px !important;
                  width: 70px !important;
                }
              }
            `;
          } else if (headerText.includes('peso') || headerText.includes('weight')) {
            // Peso - tamaño original del CSS
            css += `
              #editableFieldsTable th:nth-child(${i}),
              #editableFieldsTable td:nth-child(${i}) {
                min-width: 80px !important;
                width: 80px !important;
              }
              @media (max-width: 768px) {
                #editableFieldsTable th:nth-child(${i}),
                #editableFieldsTable td:nth-child(${i}) {
                  min-width: 65px !important;
                  width: 65px !important;
                }
              }
            `;
          } else {
            // Otros campos numéricos - tamaño como HP/ATK/SPD Entrenado
            css += `
              #editableFieldsTable th:nth-child(${i}),
              #editableFieldsTable td:nth-child(${i}) {
                min-width: 110px !important;
                width: 110px !important;
              }
              @media (max-width: 768px) {
                #editableFieldsTable th:nth-child(${i}),
                #editableFieldsTable td:nth-child(${i}) {
                  min-width: 85px !important;
                  width: 85px !important;
                }
              }
            `;
          }
        }
      }
    }
  }
  
  // Asegurar que inputs y selects ocupen todo el ancho disponible
  css += `
    #editableFieldsTable input,
    #editableFieldsTable select {
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
  `;
  
  style.textContent = css;
  
  // Remover estilo anterior
  const oldStyle = document.getElementById('dynamic-column-styles');
  if (oldStyle) {
    oldStyle.remove();
  }
  
  document.head.appendChild(style);
  
  console.log('✅ Dropdowns ajustados al mismo tamaño que HP/ATK/SPD Entrenado (110px)');
}

function observarSelectsDinamicos() {
  const target = document.getElementById('editableFields');
  if (!target) return;

  const observer = new MutationObserver((mutationsList, observer) => {
    let changed = false;

    for (const mutation of mutationsList) {
      if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
        changed = true;
      }
    }

    if (changed) {
      const selects = target.querySelectorAll('select:not([data-translated])');
      selects.forEach(select => {
        translateSelectOptions(select);
        select.setAttribute('data-translated', 'true');
      });
    }
  });

  observer.observe(target, { childList: true, subtree: true });
}

// ✅ MODIFICADO: Event listener mejorado para inicialización automática
document.addEventListener('DOMContentLoaded', function() {
  // 1. Detectar idioma automáticamente
  currentLanguage = detectLanguage();
  
  // 2. Configurar el selector de idioma
  const languageSelector = document.getElementById('languageSelector');
  if (languageSelector) {
    languageSelector.value = currentLanguage;
    
    languageSelector.addEventListener('change', function() {
      currentLanguage = this.value;
      localStorage.setItem('digilang', currentLanguage);
      updateInterfaceLanguage();
    });
  }
  
  // 3. Aplicar traducción automáticamente
  updateInterfaceLanguage();
  
  // 4. Guardar el idioma detectado
  localStorage.setItem('digilang', currentLanguage);
  
  // 5. Inicializar reorganización de campos
  reorganizeFields();
  
  // 6. Añadir observador para detectar cambios y traducir selects nuevos
  observarSelectsDinamicos();
});

// ✅ NUEVO: Función para forzar actualización de traducciones cuando sea necesario
window.forceTranslationUpdate = function() {
  updateInterfaceLanguage();
};

// ✅ NUEVO: Función específica para traducir elementos dinámicos sin bucles
window.translateNewElements = function(container) {
  if (!container) return;
  
  const elementsToTranslate = container.querySelectorAll('[data-translate]');
  elementsToTranslate.forEach(element => {
    const key = element.getAttribute('data-translate');
    element.textContent = translate(key);
  });
  
  const selects = container.querySelectorAll('select');
  selects.forEach(select => translateSelectOptions(select));
};

  </script>
  <script src="digimonReqDict.js"></script>
  <script src="digimonstattier.js"></script>

</body>
</html>